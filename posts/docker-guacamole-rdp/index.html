<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="后续：将提供 webdav 服务的 IIS 替换为 rclone Windows 远程桌面服务作为开放给外网的高权限系统组件存在很大的安全隐患，因此如果需要使用 RDP 服务，最"><meta name=theme-color content="#FFFFFF"><meta property="og:title" content="提升安全性：Nginx 反向代理 RDP 和 IIS 服务"><meta property="og:description" content="后续：将提供 webdav 服务的 IIS 替换为 rclone Windows 远程桌面服务作为开放给外网的高权限系统组件存在很大的安全隐患，因此如果需要使用 RDP 服务，最"><meta property="og:type" content="article"><meta property="og:url" content="https://const.icu/posts/docker-guacamole-rdp/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-07-13T18:49:37+08:00"><meta property="article:modified_time" content="2021-05-02T04:22:49+08:00"><title>提升安全性：Nginx 反向代理 RDP 和 IIS 服务 | 源</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.74f27c21ded7c6a7ca0603b08b5b0c47788b595c9592c8bbb7d8cd62519f3581.css integrity="sha256-dPJ8Id7XxqfKBgOwi1sMR3iLWVyVksi7t9jNYlGfNYE="><script defer src=/zh.search.min.350a34ab3cc14dcf078c266410d6840ebd01eb825657d022685b1c5820f4659a.js integrity="sha256-NQo0qzzBTc8HjCZkENaEDr0B64JWV9AiaFscWCD0ZZo="></script><script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js integrity="sha256-b2+Q/LjrHEnsOJg45rgB0N4ZQwuOUWkC+NdcPIvZhzk="></script><script src=/creadcss.min.js></script></head><body><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><nav style=color:var(--gray-700)><h2 class=book-brand><a href=/><b style=font-family:simsun,serif;font-size:3.25rem;color:var(--body-font-color)>源</b></a><div style="font-size:1.25rem;padding:1rem 0">月背荧惑</div></h2><div class=book-search><input type=text id=book-search-input placeholder=搜索 aria-label=搜索 maxlength=64 data-hotkeys><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/posts/>奇点 🗘</a></li><li><a href=/archives/>时间胶囊 ⏱</a></li><li><a href=/posts/documents/>背景辐射 🗯</a></li></ul><small style=position:absolute;margin-top:2rem><p>共 13 篇文章 ⋅ 13200 字</p><p><a rel=license href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank><img alt=知识共享许可协议 src=/by-nc-sa.svg></a></p><p>Copyright © 2021 <a href=https://const.icu target=_blank>S</a></p><p>魔改驱动自 Book 主题</p></small></nav><script>(function(){var a=document.querySelector("aside.book-menu nav");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></aside><aside class=book-toc><nav id=TableOfContents><ul><li><a href=#no-need-to-prepare-config-file>No Need To Prepare Config File</a></li><li><a href=#open-firewall-for-iis-unusual-port>Open Firewall for IIS' Unusual Port</a></li><li><a href=#install-guacamole-by-docker>Install Guacamole by Docker</a></li><li><a href=#nginx-url-rewrite>Nginx URL Rewrite</a><ul><li><a href=#assign-ips-to-vm-4>Assign IPs to VM</a></li><li><a href=#install-nginx-with-webdav-module>Install Nginx with Webdav module</a></li><li><a href=#add-proxy-config>Add Proxy Config</a></li><li><a href=#config-https-and-auth>Config HTTPS and Auth</a></li><li><a href=#manage-nginx-and-guacamole-to-autostart>Manage Nginx and Guacamole to Autostart</a></li></ul></li><li><a href=#edit-guacamole-settings>Edit Guacamole Settings</a><ul><li><a href=#add-account>Add Account</a></li><li><a href=#add-connections>Add Connections</a></li><li><a href=#test-on-connection>Test on Connection</a></li></ul></li><li><a href=#more-security-stuff>More Security Stuff</a><ul><li><a href=#expose-3389-to-hyper-v-only>Expose 3389 to Hyper-v only</a></li><li><a href=#fail-x00x03-to-ban>Fail x00/x03 to Ban</a></li></ul></li><li><a href=#appendix>APPENDIX</a></li></ul></nav></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>提升安全性：Nginx 反向代理 RDP 和 IIS 服务</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#no-need-to-prepare-config-file>No Need To Prepare Config File</a></li><li><a href=#open-firewall-for-iis-unusual-port>Open Firewall for IIS' Unusual Port</a></li><li><a href=#install-guacamole-by-docker>Install Guacamole by Docker</a></li><li><a href=#nginx-url-rewrite>Nginx URL Rewrite</a><ul><li><a href=#assign-ips-to-vm-4>Assign IPs to VM</a></li><li><a href=#install-nginx-with-webdav-module>Install Nginx with Webdav module</a></li><li><a href=#add-proxy-config>Add Proxy Config</a></li><li><a href=#config-https-and-auth>Config HTTPS and Auth</a></li><li><a href=#manage-nginx-and-guacamole-to-autostart>Manage Nginx and Guacamole to Autostart</a></li></ul></li><li><a href=#edit-guacamole-settings>Edit Guacamole Settings</a><ul><li><a href=#add-account>Add Account</a></li><li><a href=#add-connections>Add Connections</a></li><li><a href=#test-on-connection>Test on Connection</a></li></ul></li><li><a href=#more-security-stuff>More Security Stuff</a><ul><li><a href=#expose-3389-to-hyper-v-only>Expose 3389 to Hyper-v only</a></li><li><a href=#fail-x00x03-to-ban>Fail x00/x03 to Ban</a></li></ul></li><li><a href=#appendix>APPENDIX</a></li></ul></nav></aside></header><article class="markdown with-index"><h1><b><a href=/posts/docker-guacamole-rdp/>提升安全性：Nginx 反向代理 RDP 和 IIS 服务</a></b></h1><div style=color:var(--gray-700)><small>最后修改于 2021-5-2
<span itemprop=wordCount>⋅ 打字机
2.8k
⋅</span>
<span itemprop=timeRequired>穿越6分钟</span></small>
<small>/
<a href=/categories/tutorial/>tutorial</a></small>
<small>/
<a href=/tags/nginx/>nginx</a>,
<a href=/tags/docker/>docker</a>,
<a href=/tags/guacamole/>guacamole</a>,
<a href=/tags/html5/>html5</a>,
<a href=/tags/rdp/>rdp</a>,
<a href=/tags/%E5%AE%89%E5%85%A8/>安全</a>,
<a href=/tags/hyper-v/>hyper-v</a>,
<a href=/tags/linux/>linux</a>,
<a href=/tags/debian/>debian</a></small></div><p><blockquote><p>后续：<a href=/posts/change-iis-to-rclone-of-webdav/>将提供 webdav 服务的 IIS 替换为 rclone</a></p></blockquote><p>Windows 远程桌面服务作为开放给外网的高权限系统组件存在很大的安全隐患，因此如果需要使用 RDP 服务，最好不要直接开放其对应的 3389 端口。通过<code>Remote Desktop Gateway</code>这个默认存在于rdp客户端的认证通道或者是通过代理来避免端口直接暴露。以上两种方式中前者较麻烦，后者则造成每次连接远程桌面都要开启代理，都不太方便。本文介绍如何用<code>Guacamole</code>将rdp内容转换为HTTP，再由<code>Nginx</code>代理给客户端来减少暴露额外的端口带来的安全风险。<code>Nginx</code>监听 443 端口传入的 HTTPS 协议内容，并按路径转发给 Hyper-v VM Docker 中的<code>Guacamole</code>和 Windows 上的 IIS 服务端。<code>Guacamole</code>将宿主机的 RDP 服务转换成 HTML5 内容，不再需要服务端向局域网开放 3389 端口。</p><p><strong>本文基于如下环境和程序</strong></p><table><thead><tr><th>Environment</th><th>Contains</th><th></th></tr></thead><tbody><tr><td>Windows</td><td>IIS Webserver 10.0</td><td>Hyper-v (VM)</td></tr><tr><td>Debian10 VM (Hyper-v)</td><td>Nginx 1.14.2</td><td>Docker (Apache Guacamole 1.2.0)</td></tr></tbody></table><p><strong>各程序服务按外部访问流程排序</strong></p><table><thead><tr><th>Program</th><th>Usage</th><th>Env</th><th>Protocol</th><th>Address</th></tr></thead><tbody><tr><td>Nginx</td><td>HTTPS reverse proxy</td><td>Debian10 VM</td><td>HTTPS</td><td>192.168.51.118:443 Lan 192.168.208.146 VM</td></tr><tr><td>IIS Webserver</td><td>Other web app (Webdav)</td><td>Windows</td><td>HTTP</td><td>192.168.208.145:8088/S4f_/ VM</td></tr><tr><td>Guacamole</td><td>HTML5 RDP server</td><td>Debian10 VM (Docker)</td><td>HTTP</td><td>127.0.0.1:8080/rdp/ VM</td></tr><tr><td>RDP</td><td>Microsoft remote desktop</td><td>Windows</td><td>RDP</td><td>192.168.208.145:3389 VM</td></tr></tbody></table><p><strong>覆盖图</strong>
<script src=/mermaid.min.js></script><script>mermaid.initialize({flowchart:{useMaxWidth:!0},theme:"neutral"})</script><p class=mermaid>graph LR
subgraph "Hyper-V"
subgraph "VM (Debian10)"
c1[Nginx]-->|127.0.0.1<br>:8080/rdp/|c2[Guacamole<br>& SSH to self]
    end
    subgraph "Windows10"
a1["IIS Webserver<br>(WebDav)"]
a2[RDP]
end
end
b1[用户]-->|HTTPS<br>192.168.51.118|c1
c1-->|192.168.208.145<br>:8088/S4f_/|a1
c2-->|192.168.208.145<br>:3389|a2</p></p><h2 id=no-need-to-prepare-config-file>No Need To Prepare Config File
<a class=anchor href=#no-need-to-prepare-config-file>#</a></h2><p>More offcial Docs <a href=//guacamole.apache.org/doc/0.8.4/gug/configuring-guacamole.html#user-mapping>Here</a></p><blockquote><p><strong>This Part</strong> is for the native build therefore <em><strong>SHOULD BE SKIPPED</strong></em>.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p></blockquote><p>As we use docker file here, the default user has been set to <code>guacadmin</code> with password <code>guacadmin</code>.</p><h2 id=open-firewall-for-iis-unusual-port>Open Firewall for IIS' Unusual Port
<a class=anchor href=#open-firewall-for-iis-unusual-port>#</a></h2><blockquote><p><em><strong>In Windows</strong></em></p></blockquote><p>After binding port <code>8088</code> to IIS server&rsquo;s http service, there are addtional steps for unusual port other than <code>80</code> and <code>443</code>.
Open firewall advance settings, add allow rules for <code>8080</code>. In <code>Scope</code> Remote IP address part, add ip range <code>192.168.208.0</code> to <code>192.168.208.255</code>. In <code>Advance</code> Profiles part, check all three checkboxs and confirm.</p><h2 id=install-guacamole-by-docker>Install Guacamole by Docker
<a class=anchor href=#install-guacamole-by-docker>#</a></h2><blockquote><p><em><strong>In Hyper-v (Debian10)</strong></em></p></blockquote><p><a href=//hub.docker.com/r/oznu/guacamole>Docker Site</a> and <a href=//github.com/oznu/docker-guacamole>uploader&rsquo;s Github</a></p><ol><li>Add those text to a <code>Dockerfile</code> which is used for changing base url.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></li></ol><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=color:#204a87;font-weight:700>FROM</span><span style=color:#4e9a06> oznu/guacamole:latest</span><span style=color:#a40000>
</span><span style=color:#a40000>
</span><span style=color:#a40000></span><span style=color:#204a87;font-weight:700>RUN</span> <span style=color:#204a87>set</span> -x <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span><span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> rm -rf <span style=color:#4e9a06>${</span><span style=color:#000>CATALINA_HOME</span><span style=color:#4e9a06>}</span>/webapps/ROOT <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span><span style=color:#ce5c00;font-weight:700>&amp;&amp;</span> mv <span style=color:#4e9a06>${</span><span style=color:#000>CATALINA_HOME</span><span style=color:#4e9a06>}</span>/webapps/ROOT.war <span style=color:#4e9a06>${</span><span style=color:#000>CATALINA_HOME</span><span style=color:#4e9a06>}</span>/webapps/rdp.war<span style=color:#a40000>
</span></code></pre></td></tr></table></div></div><ol start=2><li>Run command at the place where you put the <code>Dockerfile</code> to bulid a new image.</li></ol><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker build -t guapath .
</code></pre></td></tr></table></div></div><ol start=3><li>Run the container (replace <code>/root/guacamole</code> with your config directory which should <code>mkdir</code> first when new build) from your new-built image.</li></ol><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -d <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  --name<span style=color:#ce5c00;font-weight:700>=</span>win10rdp <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  -p 127.0.0.1:8080:8080 <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  -v /root/guacamole:/config <span style=color:#4e9a06>\
</span><span style=color:#4e9a06></span>  guapath
</code></pre></td></tr></table></div></div><h2 id=nginx-url-rewrite>Nginx URL Rewrite
<a class=anchor href=#nginx-url-rewrite>#</a></h2><blockquote><p><em><strong>In Hyper-v (Debian10)</strong></em></p></blockquote><p><a href=//guacamole.apache.org/doc/gug/proxying-guacamole.html#nginx>Offcial Document</a></p><p>My original plan is to use <code>IIS ARR3.0</code> module to achive the URL rewrite purpose as this IIS webserver also do the job of sharing my files in Lan via Webdav. But after a query online, I find out that the support of <code>Websocket</code> in IIS which <code>Guacamole</code> needed to communicate seems lack. Therefore I use <code>Nginx</code> to do reverse proxy both for <code>Guacamole</code> in <code>Hyper-V</code> and Webdav that host on IIS.<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><h3 id=assign-ips-to-vm-4>Assign IPs to VM <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>
<a class=anchor href=#assign-ips-to-vm-4>#</a></h3><p>To get double IPs in debian VM, first you need to add two network interfaces (here for example <code>eth0</code> is external for Lan and the <code>eth1</code> is internal to host) on hyper-v. Then login to the VM and add those lines to <code>/etc/network/interfaces</code>, <code>eth1</code>&rsquo;s static ip is different from the host <code>192.168.208.145</code> (like one number after) and mask is same as host&rsquo;s (<strong>you can find those in Windows Cmd <code>ipconfig /all</code></strong>). This internal ip is related to <code>firewall</code> settings in Windows so you need to assign one manually to access the host Windows:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>auto eth0
iface eth0 inet dhcp

auto eth1
iface eth1 inet static
    ip   192.168.208.146
    mask 255.255.255.240
</code></pre></td></tr></table></div></div><p>Apply changes by <code>systemctl restart networking</code>. Type <code>ip a</code> in command to find your IPs.</p><blockquote><p><em><strong>In Windows</strong></em></p></blockquote><p>To add static IP in Windows, open Cmd(Administrator) and input:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>netsh interface ip <span style=color:#204a87>set</span> address <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;vEthernet (Default Switch)&#34;</span> static 192.168.208.145 255.255.255.240 none
</code></pre></td></tr></table></div></div><p>Add this command to <code>Manage</code>-><code>Scheduled Tasks</code>-><code>Create a Basic Task</code> and set it <code>run as administrator</code> to get static ip rather than random one that Windows assign to on startup. Disable <code>only start task when plug in power</code> and add a delay for <code>30s</code> after startup.</p><p>By default, Hyper-v will give VM a random Mac which would make your router assign new ip for your VM&rsquo;s external network on boot. Open VM&rsquo;s settings, expand your external <code>Network Adapter</code> and click on <code>Advanced Features</code>. In <code>Mac Address</code> select <code>static</code> and input a Mac address.</p><h3 id=install-nginx-with-webdav-module>Install Nginx with Webdav module
<a class=anchor href=#install-nginx-with-webdav-module>#</a></h3><blockquote><p><em><strong>In Hyper-v (Debian10)</strong></em></p></blockquote><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo apt-get install nginx-full -y
</code></pre></td></tr></table></div></div><p><strong>Remove Default Page</strong></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>rm /etc/nginx/sites-enabled/default
</code></pre></td></tr></table></div></div><h3 id=add-proxy-config>Add Proxy Config
<a class=anchor href=#add-proxy-config>#</a></h3><p>Add those lines to your <code>/etc/nginx/nginx.conf</code> file inside the <code>server</code> section.
Replace <code>rdp</code> with your <code>guacamole</code>&rsquo;s url path.</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx>    <span style=color:#204a87;font-weight:700>location</span> <span style=color:#4e9a06>/rdp/</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>proxy_redirect</span> <span style=color:#000>off</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_buffering</span> <span style=color:#000>off</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_http_version</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#4e9a06>.1</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_set_header</span> <span style=color:#4e9a06>X-Forwarded-For</span> <span style=color:#000>$proxy_add_x_forwarded_for</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_set_header</span> <span style=color:#4e9a06>Upgrade</span> <span style=color:#000>$http_upgrade</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_set_header</span> <span style=color:#4e9a06>Connection</span> <span style=color:#000>$http_connection</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>access_log</span> <span style=color:#000>off</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_pass</span> <span style=color:#4e9a06>http://127.0.0.1:8080/rdp/</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
</code></pre></td></tr></table></div></div><p>Replace <code>S4f_</code> with your IIS Webdav url path, and <code>192.168.208.145</code> with your Windows&rsquo;s internal ip. I also changed the query string from client to IIS to fix problems (it&rsquo;s an <strong>Nginx bug</strong> when reverse proxy a webdav request, especially when use <code>MOVE</code> method, the <code>Destination</code> header would be set as nginx&rsquo;s address rather than IIS' <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>) <del>by <code>if set</code></del>.<br><strong>add in http</strong></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx>    <span style=color:#204a87;font-weight:700>map</span> <span style=color:#000>$http_destination</span> <span style=color:#000>$destination</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>~*(https?:\/\/)([a-z0-9\.]+\/)(.+)$</span> <span style=color:#4e9a06>http://192.168.208.145:8088/</span><span style=color:#000>$3</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>default</span> <span style=color:#000>$http_destination</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
</code></pre></td></tr></table></div></div><p><strong>add in server</strong></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx>    <span style=color:#204a87;font-weight:700>location</span> <span style=color:#4e9a06>/S4f_/</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic># allow webdav to max upload 4G
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>client_max_body_size</span> <span style=color:#0000cf;font-weight:700>4096m</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_redirect</span>      <span style=color:#000>off</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_buffering</span>     <span style=color:#000>off</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_http_version</span>  <span style=color:#0000cf;font-weight:700>1</span><span style=color:#4e9a06>.1</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_set_header</span>    <span style=color:#4e9a06>Destination</span>          <span style=color:#000>$destination</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#8f5902;font-style:italic># don&#39;t set this header as webdav destination check needed
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#8f5902;font-style:italic># proxy_set_header    Host                 $http_host;
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>proxy_set_header</span>    <span style=color:#4e9a06>X-Real-IP</span>            <span style=color:#000>$remote_addr</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_set_header</span>    <span style=color:#4e9a06>X-Forwarded-For</span>      <span style=color:#000>$proxy_add_x_forwarded_for</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_set_header</span>    <span style=color:#4e9a06>http_x_forwarded_for</span> <span style=color:#000>$remote_addr</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_set_header</span>    <span style=color:#4e9a06>remote_addr</span>          <span style=color:#000>$remote_addr</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>access_log</span>          <span style=color:#000>off</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#204a87;font-weight:700>proxy_pass</span> <span style=color:#4e9a06>http://192.168.208.145:8088/S4f_/</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
</code></pre></td></tr></table></div></div><h3 id=config-https-and-auth>Config HTTPS and Auth
<a class=anchor href=#config-https-and-auth>#</a></h3><p>About how to generate self-signed certificate, you can refer to <a href=../self-signed-ca-server-cert>Here</a>.<br>Copy your <code>server.crt</code> and <code>server.key</code> to <code>nginx/</code> folder (use <code>scp /path/to/file username@ip.ip.ip.ip:/path/to/destination</code> or <code>Winscp</code>).<br>You can add extra auth for anyone who visit the site by nginx&rsquo;s <code>basic auth</code><sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>.<br>Replace <code>server</code> config with following lines.</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#204a87;font-weight:700>server</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#204a87;font-weight:700>listen</span>       <span style=color:#0000cf;font-weight:700>443</span> <span style=color:#4e9a06>ssl</span> <span style=color:#4e9a06>http2</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>server_name</span>  <span style=color:#4e9a06>localhost</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>server_tokens</span> <span style=color:#000>off</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>ssl_certificate</span>     <span style=color:#4e9a06>server.crt</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>ssl_certificate_key</span> <span style=color:#4e9a06>server.key</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>ssl_protocols</span>       <span style=color:#4e9a06>TLSv1.2</span> <span style=color:#4e9a06>TLSv1.3</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>ssl_prefer_server_ciphers</span> <span style=color:#000>on</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>ssl_ciphers</span>         <span style=color:#4e9a06>HIGH:!aNULL:!MD5</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#204a87;font-weight:700>add_header</span> <span style=color:#4e9a06>Strict-Transport-Security</span> <span style=color:#4e9a06>&#34;max-age=31536000</span><span style=color:#000;font-weight:700>;</span> <span style=color:#204a87;font-weight:700>includeSubDomains&#34;</span> <span style=color:#4e9a06>always</span><span style=color:#000;font-weight:700>;</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></td></tr></table></div></div><p>And to disable default nginx index page, add in <code>server</code>:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx>    <span style=color:#204a87;font-weight:700>location</span> <span style=color:#4e9a06>/</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>404</span><span style=color:#000;font-weight:700>;</span>
    <span style=color:#000;font-weight:700>}</span>
</code></pre></td></tr></table></div></div><hr><p><strong>As a summary, your <code>nginx.conf</code> file should look like this:</strong></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nginx data-lang=nginx><span style=color:#8f5902;font-style:italic># Default settings and others
</span><span style=color:#8f5902;font-style:italic></span><span style=color:#204a87;font-weight:700>http</span> <span style=color:#000;font-weight:700>{</span>
    <span style=color:#8f5902;font-style:italic># Default but remember to delete SSL-related settings
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#8f5902;font-style:italic># Because it&#39;s included in server
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#204a87;font-weight:700>map</span> <span style=color:#000>$http_destination</span> <span style=color:#000>$destination</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic># ..
</span><span style=color:#8f5902;font-style:italic></span>    <span style=color:#000;font-weight:700>}</span>
    <span style=color:#204a87;font-weight:700>server</span> <span style=color:#000;font-weight:700>{</span>
        <span style=color:#8f5902;font-style:italic># ...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#204a87;font-weight:700>location</span> <span style=color:#4e9a06>/</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#204a87;font-weight:700>return</span> <span style=color:#0000cf;font-weight:700>404</span><span style=color:#000;font-weight:700>;</span>
        <span style=color:#000;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>location</span> <span style=color:#4e9a06>/rdp/</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic># ...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000;font-weight:700>}</span>
        <span style=color:#204a87;font-weight:700>location</span> <span style=color:#4e9a06>/S4f_/</span> <span style=color:#000;font-weight:700>{</span>
            <span style=color:#8f5902;font-style:italic># ...
</span><span style=color:#8f5902;font-style:italic></span>        <span style=color:#000;font-weight:700>}</span>
    <span style=color:#000;font-weight:700>}</span>
<span style=color:#000;font-weight:700>}</span>
</code></pre></td></tr></table></div></div><p>When done, restart your Nginx service:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo systemctl restart nginx
</code></pre></td></tr></table></div></div><h3 id=manage-nginx-and-guacamole-to-autostart>Manage Nginx and Guacamole to Autostart
<a class=anchor href=#manage-nginx-and-guacamole-to-autostart>#</a></h3><p>For <code>Nginx</code>:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#8f5902;font-style:italic># nginx autostart (enable)/ disable (disable)</span>
sudo systemctl <span style=color:#204a87>enable</span> nginx
<span style=color:#8f5902;font-style:italic># nginx start/stop/status</span>
sudo systemctl start nginx
</code></pre></td></tr></table></div></div><p>To check port use <code>lsof -i -P</code>.The Nginx log is in <code>/var/log/nginx/</code> as <code>access.log</code> and <code>error.log</code> for debug.</p><hr><p>For <code>Guacamole</code>, in <code>/etc/systemd/system/docker-win10rdp.service</code> add:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=color:#000;font-weight:700>[</span><span style=color:#000>Unit</span><span style=color:#000;font-weight:700>]</span>
<span style=color:#000>Description</span><span style=color:#000;font-weight:700>=</span><span style=color:#000>Docker</span> <span style=color:#000>for</span> <span style=color:#000>win10rdp</span>
<span style=color:#000>Requires</span><span style=color:#000;font-weight:700>=</span><span style=color:#000>docker</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>service</span>
<span style=color:#000>After</span><span style=color:#000;font-weight:700>=</span><span style=color:#000>docker</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>service</span>

<span style=color:#000;font-weight:700>[</span><span style=color:#000>Service</span><span style=color:#000;font-weight:700>]</span>
<span style=color:#000>Restart</span><span style=color:#000;font-weight:700>=</span><span style=color:#000>always</span>
<span style=color:#000>ExecStart</span><span style=color:#000;font-weight:700>=</span><span style=color:#a40000>/</span><span style=color:#000>usr</span><span style=color:#a40000>/</span><span style=color:#000>bin</span><span style=color:#a40000>/</span><span style=color:#000>docker</span> <span style=color:#000>start</span> <span style=color:#a40000>-</span><span style=color:#000>a</span> <span style=color:#000>win10rdp</span>
<span style=color:#000>ExecStop</span><span style=color:#000;font-weight:700>=</span><span style=color:#a40000>/</span><span style=color:#000>usr</span><span style=color:#a40000>/</span><span style=color:#000>bin</span><span style=color:#a40000>/</span><span style=color:#000>docker</span> <span style=color:#000>stop</span> <span style=color:#a40000>-</span><span style=color:#000>t</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#000>win10rdp</span>

<span style=color:#000;font-weight:700>[</span><span style=color:#000>Install</span><span style=color:#000;font-weight:700>]</span>
<span style=color:#000>WantedBy</span><span style=color:#000;font-weight:700>=</span><span style=color:#000>default</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>target</span>
</code></pre></td></tr></table></div></div><p>Enable the service:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo systemctl <span style=color:#204a87>enable</span> docker-win10rdp.service
</code></pre></td></tr></table></div></div><h2 id=edit-guacamole-settings>Edit Guacamole Settings
<a class=anchor href=#edit-guacamole-settings>#</a></h2><blockquote><p><em><strong>In Browser</strong></em></p></blockquote><h3 id=add-account>Add Account
<a class=anchor href=#add-account>#</a></h3><p>Access <code>Guacamole</code>&rsquo;s web page using your VM&rsquo;s external ip address <code>https://192.168.51.118/rdp</code> with <code>guacadmin</code> for both username and password.<br>After a successfully login, open settings and click on the <code>Users</code>. Create your own account with all permissions checked. Sign in your own account and delete the default <code>guacadmin</code> one.</p><h3 id=add-connections>Add Connections
<a class=anchor href=#add-connections>#</a></h3><p>Click on the <code>New Connection</code> inside the <code>Connections</code>. Fill the Name, Protocol, Hostname (Hyper-v internal ip), Port, Username, Password, Security Mode and check the <code>Ignore server certificate</code>. Save the changes.</p><blockquote><p><em><strong>In Hyper-v (Debian10)</strong></em></p></blockquote><p>If you want to enhance VM server&rsquo;s security, you can add a <code>ssh</code> connection from docker to host. Use <code>ip a</code> to check <code>docker0</code> host&rsquo;s ip. Also, change the settings in <code>/etc/ssh/sshd_config</code> by change <code>port</code> and <code>listenAddress</code>. Apply changes <code>sudo systemctl restart sshd</code>:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>Port <span style=color:#0000cf;font-weight:700>25678</span>
<span style=color:#8f5902;font-style:italic># same as docker0 in ip a</span>
ListenAddress 172.18.0.1
</code></pre></td></tr></table></div></div><p>Also add these command after <code>sudo systemctl edit sshd</code> to allow <code>sshd</code> start when <code>docker0</code>&rsquo;s ready:</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#ce5c00;font-weight:700>[</span>Service<span style=color:#ce5c00;font-weight:700>]</span>
<span style=color:#000>Restart</span><span style=color:#ce5c00;font-weight:700>=</span>on-failure
<span style=color:#000>RestartSec</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span>
<span style=color:#000>RestartPreventExitStatus</span><span style=color:#ce5c00;font-weight:700>=</span>
</code></pre></td></tr></table></div></div><h3 id=test-on-connection>Test on Connection
<a class=anchor href=#test-on-connection>#</a></h3><blockquote><p><em><strong>In Browser</strong></em></p></blockquote><p>Back to <code>Home</code>, click on the connection you just added. Check if everything is fine.</p><h2 id=more-security-stuff>More Security Stuff
<a class=anchor href=#more-security-stuff>#</a></h2><h3 id=expose-3389-to-hyper-v-only>Expose 3389 to Hyper-v only
<a class=anchor href=#expose-3389-to-hyper-v-only>#</a></h3><blockquote><p><em><strong>In Windows</strong></em></p></blockquote><p>Open firewall advance settings, add two allow rules for TCP and UDP port<code>3389</code>. In <code>Scope</code> Remote IP address part, add ip range <code>192.168.208.0</code> to <code>192.168.208.255</code>. In <code>Advance</code> Profiles part, check all three checkboxs and confirm. Disable old TCP and UDP port <code>3389</code> allow rules.</p><h3 id=fail-x00x03-to-ban>Fail x00/x03 to Ban
<a class=anchor href=#fail-x00x03-to-ban>#</a></h3><blockquote><p><em><strong>In Hyper-v (Debian10)</strong></em></p></blockquote><p>Install fail2ban</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo apt-get install fail2ban
</code></pre></td></tr></table></div></div><p>Edit your config file from template</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo nano /etc/fail2ban/jail.local
</code></pre></td></tr></table></div></div><p>Add your client ip to <code>ignoreip</code></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=color:#000;font-weight:700>[</span><span style=color:#000>DEFAULT</span><span style=color:#000;font-weight:700>]</span>
<span style=color:#8f5902;font-style:italic># ...</span>
<span style=color:#000>ignoreip</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>127.0</span><span style=color:#000;font-weight:700>.</span><span style=color:#0000cf;font-weight:700>0.1</span><span style=color:#a40000>/</span><span style=color:#0000cf;font-weight:700>8</span> <span style=color:#a40000>::</span><span style=color:#0000cf;font-weight:700>1</span> <span style=color:#000>your</span><span style=color:#a40000>-</span><span style=color:#000>ip</span><span style=color:#a40000>-</span><span style=color:#000>address</span><span style=color:#a40000>-</span><span style=color:#000>here</span>
</code></pre></td></tr></table></div></div><p>Modify default <code>bantime</code>, <code>findtime</code> and <code>maxretry</code></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=color:#8f5902;font-style:italic># &#34;bantime&#34; is the number of seconds that a host is banned.</span>
<span style=color:#000>bantime</span>  <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>48</span><span style=color:#000>h</span> <span style=color:#8f5902;font-style:italic># -1 means permanant</span>

<span style=color:#8f5902;font-style:italic># A host is banned if it has generated &#34;maxretry&#34; during the last &#34;findtime&#34; </span>
<span style=color:#8f5902;font-style:italic># seconds.</span>
<span style=color:#000>findtime</span>  <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span><span style=color:#000>m</span>

<span style=color:#8f5902;font-style:italic># &#34;maxretry&#34; is the number of failures before a host get banned.</span>
<span style=color:#000>maxretry</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>10</span>
</code></pre></td></tr></table></div></div><p>Create your special jail in <code>jail.local</code></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=color:#000;font-weight:700>[</span><span style=color:#000>nginx</span><span style=color:#a40000>-</span><span style=color:#000>x0x</span><span style=color:#000;font-weight:700>]</span> 
<span style=color:#000>enabled</span>   <span style=color:#000;font-weight:700>=</span> <span style=color:#204a87;font-weight:700>true</span> 
<span style=color:#000>port</span>      <span style=color:#000;font-weight:700>=</span> <span style=color:#000>http</span><span style=color:#000;font-weight:700>,</span><span style=color:#000>https</span> 
<span style=color:#000>filter</span>    <span style=color:#000;font-weight:700>=</span> <span style=color:#000>nginx</span><span style=color:#a40000>-</span><span style=color:#000>x0x</span>
<span style=color:#000>logpath</span>   <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>/</span><span style=color:#000>var</span><span style=color:#a40000>/</span><span style=color:#000>log</span><span style=color:#a40000>/</span><span style=color:#000>nginx</span><span style=color:#a40000>/</span><span style=color:#000>access</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>log</span>
</code></pre></td></tr></table></div></div><p>Create filter for Nginx x0x (like 403) error</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo nano /etc/fail2ban/filter.d/nginx-x0x.conf
</code></pre></td></tr></table></div></div><p>Add</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-toml data-lang=toml><span style=color:#000;font-weight:700>[</span><span style=color:#000>Definition</span><span style=color:#000;font-weight:700>]</span> 
<span style=color:#000>failregex</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#a40000>^&lt;</span><span style=color:#000>HOST</span><span style=color:#a40000>&gt;</span><span style=color:#000;font-weight:700>.</span><span style=color:#a40000>*</span><span style=color:#4e9a06>&#34;(GET|POST|HEAD).*&#34;</span> <span style=color:#a40000>(</span><span style=color:#0000cf;font-weight:700>404</span><span style=color:#a40000>|</span><span style=color:#0000cf;font-weight:700>444</span><span style=color:#a40000>|</span><span style=color:#0000cf;font-weight:700>403</span><span style=color:#a40000>|</span><span style=color:#0000cf;font-weight:700>400</span><span style=color:#a40000>)</span> <span style=color:#000;font-weight:700>.</span><span style=color:#a40000>*$</span>
<span style=color:#000>ignoreregex</span> <span style=color:#000;font-weight:700>=</span>
</code></pre></td></tr></table></div></div><p>You can test your regex here</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>fail2ban-regex /var/log/nginx/access.log /etc/fail2ban/filter.d/nginx-x0x.conf
</code></pre></td></tr></table></div></div><p>Restart <code>fail2ban</code></p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo systemctl restart fail2ban
</code></pre></td></tr></table></div></div><p>To see status</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo fail2ban-client status nginx-x0x 
</code></pre></td></tr></table></div></div><p>To rescue from jail</p><div class=highlight><div style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>sudo fail2ban-client <span style=color:#204a87>set</span> nginx-x0x unbanip &lt;ip&gt;
</code></pre></td></tr></table></div></div><h2 id=appendix>APPENDIX
<a class=anchor href=#appendix>#</a></h2><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><blockquote><p><strong>Deprecated</strong><br>Changing the config of Guacamole is now in its GUI control panel instead of in its config file.</p></blockquote><p>First, prepare the config file that will be used by <code>guacamole</code>.<br>Replace <code>192.168.208.145</code> with your <code>Windows</code> IP address or <code>Hostname</code> (<strong>not recommend</strong>) connected to the <code>Hyper-v</code> (as <code>192.168.208.146</code> is the VM&rsquo;s IP that <code>Hyper-v</code> assigned to). Also don&rsquo;t forget to change the <code>username</code> and <code>password (md5)</code>.<br>In <code>Debian</code>, you can use <code>md5sum &lt;File contains PASSWORD></code> to hash your plain password.<br><strong>/root/guacamole/user-mapping.xml</strong>
```xml
<user-mapping></p><pre><code>    &lt;!-- Another user, but using md5 to hash the password
        (example below uses the md5 hash of &quot;PASSWORD&quot;) --&gt;
    &lt;authorize 
            username=&quot;admin&quot;
            password=&quot;**PASSWORD CONVERT TO MD5**&quot;
            encoding=&quot;md5&quot;&gt;
    &lt;connection name=&quot;Unique Name&quot;&gt;
        &lt;protocol&gt;rdp&lt;/protocol&gt;
        &lt;param name=&quot;hostname&quot;&gt;192.168.208.145&lt;/param&gt;
        &lt;param name=&quot;port&quot;&gt;3389&lt;/param&gt;
    &lt;/connection&gt;
    &lt;/authorize&gt;

&lt;/user-mapping&gt;
```
</code></pre>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li><li id=fn:2 role=doc-endnote><blockquote><p><strong>Failed</strong><br>Failed on <code>COPY root /</code>.</p></blockquote><p>(This file is originated from <a href=//github.com/oznu/docker-guacamole/><code>oznu/guacamole</code></a>, however the path in <code>curl -SLo ${CATALINA_HOME}/webapps/ROOT.war</code> has been changed to <code>${CATALINA_HOME}/webapps/rdp.war</code> which is same to <code>https://.../rdp</code>).</p><pre><code>```dockerfile
FROM library/tomcat:9-jre11

ENV ARCH=amd64 \
GUAC_VER=1.2.0 \
GUACAMOLE_HOME=/app/guacamole \
PG_MAJOR=9.6 \
PGDATA=/config/postgres \
POSTGRES_USER=guacamole \
POSTGRES_DB=guacamole_db

# Apply the s6-overlay

RUN curl -SLO &quot;https://github.com/just-containers/s6-overlay/releases/download/v1.20.0.0/s6-overlay-${ARCH}.tar.gz&quot; \
&amp;&amp; tar -xzf s6-overlay-${ARCH}.tar.gz -C / \
&amp;&amp; tar -xzf s6-overlay-${ARCH}.tar.gz -C /usr ./bin \
&amp;&amp; rm -rf s6-overlay-${ARCH}.tar.gz \
&amp;&amp; mkdir -p ${GUACAMOLE_HOME} \
    ${GUACAMOLE_HOME}/lib \
    ${GUACAMOLE_HOME}/extensions

WORKDIR ${GUACAMOLE_HOME}

# Install dependencies
RUN apt-get update &amp;&amp; apt-get install -y \
    libcairo2-dev libjpeg62-turbo-dev libpng-dev \
    libossp-uuid-dev libavcodec-dev libavutil-dev \
    libswscale-dev freerdp2-dev libfreerdp-client2-2 libpango1.0-dev \
    libssh2-1-dev libtelnet-dev libvncserver-dev \
    libpulse-dev libssl-dev libvorbis-dev libwebp-dev libwebsockets-dev \
    ghostscript postgresql-${PG_MAJOR} \
&amp;&amp; rm -rf /var/lib/apt/lists/*

# Link FreeRDP to where guac expects it to be
RUN [ &quot;$ARCH&quot; = &quot;armhf&quot; ] &amp;&amp; ln -s /usr/local/lib/freerdp /usr/lib/arm-linux-gnueabihf/freerdp || exit 0
RUN [ &quot;$ARCH&quot; = &quot;amd64&quot; ] &amp;&amp; ln -s /usr/local/lib/freerdp /usr/lib/x86_64-linux-gnu/freerdp || exit 0

# Install guacamole-server
RUN curl -SLO &quot;http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/${GUAC_VER}/source/guacamole-server-${GUAC_VER}.tar.gz&quot; \
&amp;&amp; tar -xzf guacamole-server-${GUAC_VER}.tar.gz \
&amp;&amp; cd guacamole-server-${GUAC_VER} \
&amp;&amp; ./configure \
&amp;&amp; make -j$(getconf _NPROCESSORS_ONLN) \
&amp;&amp; make install \
&amp;&amp; cd .. \
&amp;&amp; rm -rf guacamole-server-${GUAC_VER}.tar.gz guacamole-server-${GUAC_VER} \
&amp;&amp; ldconfig

# Install guacamole-client and postgres auth adapter
RUN set -x \
&amp;&amp; rm -rf ${CATALINA_HOME}/webapps/ROOT \
&amp;&amp; curl -SLo ${CATALINA_HOME}/webapps/rdp.war &quot;http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/${GUAC_VER}/binary/guacamole-${GUAC_VER}.war&quot; \
&amp;&amp; curl -SLo ${GUACAMOLE_HOME}/lib/postgresql-42.1.4.jar &quot;https://jdbc.postgresql.org/download/postgresql-42.1.4.jar&quot; \
&amp;&amp; curl -SLO &quot;http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/${GUAC_VER}/binary/guacamole-auth-jdbc-${GUAC_VER}.tar.gz&quot; \
&amp;&amp; tar -xzf guacamole-auth-jdbc-${GUAC_VER}.tar.gz \
&amp;&amp; cp -R guacamole-auth-jdbc-${GUAC_VER}/postgresql/guacamole-auth-jdbc-postgresql-${GUAC_VER}.jar ${GUACAMOLE_HOME}/extensions/ \
&amp;&amp; cp -R guacamole-auth-jdbc-${GUAC_VER}/postgresql/schema ${GUACAMOLE_HOME}/ \
&amp;&amp; rm -rf guacamole-auth-jdbc-${GUAC_VER} guacamole-auth-jdbc-${GUAC_VER}.tar.gz

# Add optional extensions
RUN set -xe \
&amp;&amp; mkdir ${GUACAMOLE_HOME}/extensions-available \
&amp;&amp; for i in auth-ldap auth-duo auth-header auth-cas auth-openid auth-quickconnect auth-totp; do \
    echo &quot;http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/${GUAC_VER}/binary/guacamole-${i}-${GUAC_VER}.tar.gz&quot; \
    &amp;&amp; curl -SLO &quot;http://apache.org/dyn/closer.cgi?action=download&amp;filename=guacamole/${GUAC_VER}/binary/guacamole-${i}-${GUAC_VER}.tar.gz&quot; \
    &amp;&amp; tar -xzf guacamole-${i}-${GUAC_VER}.tar.gz \
    &amp;&amp; cp guacamole-${i}-${GUAC_VER}/guacamole-${i}-${GUAC_VER}.jar ${GUACAMOLE_HOME}/extensions-available/ \
    &amp;&amp; rm -rf guacamole-${i}-${GUAC_VER} guacamole-${i}-${GUAC_VER}.tar.gz \
;done

ENV PATH=/usr/lib/postgresql/${PG_MAJOR}/bin:$PATH
ENV GUACAMOLE_HOME=/config/guacamole

WORKDIR /config

COPY root /

EXPOSE 8080

ENTRYPOINT [ &quot;/init&quot; ]
```
</code></pre>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li><li id=fn:3 role=doc-endnote><blockquote><p><strong>Deprecated</strong><br>Use nginx reverse proxy instead because ARR&rsquo;s lack of Websocket support.</p></blockquote><p><strong>Install Application Request Routing (ARR) Module</strong><br>Install <code>ARR 3.0</code> for <code>Reverse Proxy</code> support. You can install the ARR module directly from the location: <a href="http://www.microsoft.com/web/gallery/install.aspx?appid=ARRv3_0">http://www.microsoft.com/web/gallery/install.aspx?appid=ARRv3_0</a>.</p><p><strong>Change URL Rewrite Settings</strong><br>Open the <code>IIS Manager</code> and open the <code>Default Web Site</code> config pannel. Then double click on the <code>URL Rewrite</code> option.<br>Add 2 rules for <code>Inbound rules</code> and another one for <code>Outbound Rules</code> by clicking on the <code>Add Rule(s)...</code> action and Choose the <code>Blank Rule</code> template. Contents that needed to be changed are in the following tables:</p><p><strong>Inbound Rules</strong><br>The first line of the table prevent address <code>/S4f_/</code> (another web app that hosted on the IIS server) to be rewritten to the <code>rdp</code> sevice. Also need to check the <strong>Append query string</strong> checkbox.</p><pre><code>|Name|Input|Match|Pattern|Action Type|Action URL|Stop Processing|
|-|-|-|-|-|-|-|
|S4f| - |match|S4f_(/?)(.*)|Rewrite|{R:0}|True|
|rdp| - |match|rdp(/?)(.*)|Rewrite|http://172.17.111.38:8080/{R:0}|True|
</code></pre>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></li><li id=fn:4 role=doc-endnote><blockquote><p><strong>Deprecated</strong><br>The hostname that Hyper-v provided is not stable. It&rsquo;s better set static ip both manually.</p></blockquote><p>The old host-accessed-by-hostname (<code>HOSTNAME.mshome.net</code>) plan isn&rsquo;t unstable enough than assigning static ip to both host <code>192.168.208.145</code> and VM <code>192.168.208.146</code>.&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><blockquote><p><strong>Important</strong><br>There is a <strong>bug</strong> when Nginx handle reverse proxy to a webdav server. Related <a href=https://serverfault.com/questions/121766/webdav-rename-fails-on-an-apache-mod-dav-install-behind-nginx>discussion</a> and <a href=https://github.com/keeweb/keeweb/issues/1326>webdav path requirement</a>.</p></blockquote><p>In Nginx&rsquo;s reverse proxy part <code>S4f_</code>, I add extra filter to change query uri for webdav service. I&rsquo;m using <code>rclone</code> as my Webdav client, <del>however, it contains bugs while sending requests to a proxyed server</del>.
For example, <code>rclone</code> sends webdav method <code>MOVE</code> and query uri <code>https://&lt;nginx>/S4f_/path/to/file</code> to the server to rename a file while the correct query uri without proxy is <code>http://&lt;IIS>/S4f_/path/to/file</code>. <del>Therefore, to fix the problem, I add extra if-statement and regex <code>set</code> to convert path that contains scheme and server name to relative path</del>.<br><strong>Edit1</strong>: It seems that it&rsquo;s a common problem when use Nginx as reverse proxy and not just the bug of rclone. More information about this is in description above. The Webdav server will check the <code>Destination</code> header in query uri if it match the internal server.<br><strong>Edit2</strong>: Because of <a href=https://tools.ietf.org/html/rfc2518#section-9.3>RFC2518</a>, <code>Destination</code> header should be absolute URI. Convert it to relative is not the solution. The better way is to rewrite the scheme and path to match the internal communication when proxy to IIS backend.<br><strong>Edit3</strong>: <code>if-state</code> in Nginx will double escape() the query string (like convert already converted string <code>%6E</code> to <code>%256E</code>). So I use <code>map</code> (<strong>should be placed in <code>http</code> section</strong>) instead. For some reason, <code>IIS Webdav</code> server behind proxy will check if <code>MOVE</code> method&rsquo;s query string <code>Destination</code> is match the proxyed <code>Host</code>. To avoid error, delete or comment the <code>proxy_set_header host $http_host</code> in <code>location /S4f_/ {..}</code>.&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6 role=doc-endnote><blockquote><p><strong>Optional</strong><br>Set basic auth for Nginx.</p></blockquote><p>Generate your <code>conf/userpass.txt</code> file by command <code>htpasswd</code> or online <code>MD5 htpasswd</code> generator. Text inside are like <code>share:$apr1$AOW5qtOx$7D3rsVK/jIQuQYqd11/Xg0</code>.
Add those lines in your <code>nginx.conf</code> <code>server</code> section.
<code>nginx auth_basic "Auth"; auth_basic_user_file userpass.txt; </code>&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></p></article><script src=/qrious.min.js></script><script>hasQr=!1;function showQr(a){a&&!hasQr&&(new QRious({element:document.getElementById('qr'),value:location.href}),hasQr=!0),document.getElementById('qr').style.display=a?"block":"none"}</script><div class=markdown><blockquote class="book-hint danger" style=margin-top:2rem onmouseover=showQr(!0) onmouseout=showQr(!1)><canvas id=qr style=position:absolute;right:1rem></canvas>
<small><p class=copyright-item><b>调查员：</b>S</p><p>创建时间：2020年07月13日 - 18时49分</p><p>最后修改：2021年05月02日 - 04时22分</p><p class=copyright-item><b>区域（二维码）：</b>
<a title=返回顶部 href=https://const.icu/posts/docker-guacamole-rdp/#>https://const.icu/posts/docker-guacamole-rdp/↩︎</a></p><b><p class="copyright-item lincese">采用<a rel=license href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank>知识共享署名-非商业性使用-相同方式共享 4.0 国际许可协议</a>进行许可</p></b></small></blockquote></div><footer class=book-footer><div class="flex flex-wrap justify-between"></div></footer><div class=book-comments><span id=/posts/docker-guacamole-rdp/ class=leancloud_visitors data-flag-title="提升安全性：Nginx 反向代理 RDP 和 IIS 服务"><small><details class=post-meta-item-text><summary>时空乱流记录</summary>
<a href=https://console.leancloud.app/ target=_blank><img src=/90cf159733e558137ed20aa04d09964436f618a1.png style=max-width:27px><small> <span class=leancloud-visitors-count></span>+</small></a></details></small></span><br><div id=vcomments></div><script src=/av-min.js></script><script src=/Valine.min.js></script><script type=text/javascript>setTimeout(function(){new Valine({el:'#vcomments',appId:'O8B7EmkI0g7b1RzB4FtJrXvl-MdYXbMMI',appKey:'KM4TV4SUH6qzz8sN8JWU9tKL',avatar:'retro',placeholder:'支持Markdown语法 つω⊂',recordIP:!0,visitor:!0,requiredFields:["mail"],meta:["nick","mail"],emojiCDN:'//i0.hdslb.com/bfs/emote/',emojiMaps:{tv_doge:"6ea59c827c414b4a2955fe79e0f6fd3dcd515e24.png","tv_亲亲":"a8111ad55953ef5e3be3327ef94eb4a39d535d06.png","tv_偷笑":"bb690d4107620f1c15cff29509db529a73aee261.png","tv_再见":"180129b8ea851044ce71caf55cc8ce44bd4a4fc8.png","tv_冷漠":"b9cbc755c2b3ee43be07ca13de84e5b699a3f101.png","tv_发怒":"34ba3cd204d5b05fec70ce08fa9fa0dd612409ff.png","tv_发财":"34db290afd2963723c6eb3c4560667db7253a21a.png","tv_可爱":"9e55fd9b500ac4b96613539f1ce2f9499e314ed9.png","tv_吐血":"09dd16a7aa59b77baa1155d47484409624470c77.png","tv_呆":"fe1179ebaa191569b0d31cecafe7a2cd1c951c9d.png","tv_呕吐":"9f996894a39e282ccf5e66856af49483f81870f3.png","tv_困":"241ee304e44c0af029adceb294399391e4737ef2.png","tv_坏笑":"1f0b87f731a671079842116e0991c91c2c88645a.png","tv_大佬":"093c1e2c490161aca397afc45573c877cdead616.png","tv_大哭":"23269aeb35f99daee28dda129676f6e9ea87934f.png","tv_委屈":"d04dba7b5465779e9755d2ab6f0a897b9b33bb77.png","tv_害羞":"a37683fb5642fa3ddfc7f4e5525fd13e42a2bdb1.png","tv_尴尬":"7cfa62dafc59798a3d3fb262d421eeeff166cfa4.png","tv_微笑":"70dc5c7b56f93eb61bddba11e28fb1d18fddcd4c.png","tv_思考":"90cf159733e558137ed20aa04d09964436f618a1.png","tv_惊吓":"0d15c7e2ee58e935adc6a7193ee042388adc22af.png","雪未来-太棒了":"d03c1d062bb4f346c1041ca60bc763d404ddbd56.png","雪未来-摸头":"c7389d48b89699ecfeec373f90c8c26ea6d3496b.png","雪未来-击掌":"bd257c4ce22fca6a810c74873e90b343ddcead68.png","雪未来-等一等":"16e50092a82375171513018f372ed72377fcd979.png","雪未来-忽然出现":"02ba37478cdb287f40b2a328c5755873937cc417.png","雪未来-喝奶茶":"7847100be4de8cb3bf25825af165bed4f0668084.png","雪未来-冲呀":"d5a14055c8b4b457d7d815c79e7e4180299b375d.png","雪未来-下雪了":"12d2ef42e75d2806bb8a071476e825c58e797f1a.png","雪未来-堆雪人":"b2ee932586ee69f1a5ba69676f5fd345b4cd069a.png","雪未来-赖床":"239d2acb5dc2b96ec98af1ba1a81f49c8b211cd4.png","雪未来-忍住不笑":"852cc4cc73caa982b07bcbe48683d20be6c8df61.png","雪未来-打气":"1eafe084dccb3c8afff05b21d302e40e06dd07dd.png","雪未来-叹气":"a515cd6aa54093c1ccb364f22360620e2d5d76cb.png","雪未来-给你惊喜":"0b552c42157aef2002f8e9c05b06939ac3226127.png","雪未来-生气":"27e30065621ff3c981102b60865872d1be40fcd7.png","雪未来-早安":"7d941da6f69bf256b71b2f4c813c9e15bc6f89fa.png","雪未来-挠头":"6c5f3b58a568185b9844e902c632ee5cf362170d.png","雪未来-嘿嘿":"7bee0f7af3eef454f9107e883b1c5988fada42a5.png","雪未来-唱歌":"1ac8692986fc4e3d271fa14289f99d5d11dee54d.png","雪未来-泪目":"7d721758533a060933d6cef176012bf15f0fba81.png"}})},1e3)</script></div><label for=menu-control class="hidden book-menu-overlay"></label></div><script src=/clipboard.min.js></script><script>(function(){var b,a,c;function d(b){var a=document.createElement("div");a.className="copy-btn",a.textContent="复制",b.prepend(a)}b=document.querySelectorAll('pre > code');for(a=0,c=b.length;a<c;a++)b[a].className&&d(b[a].parentElement);new ClipboardJS('.copy-btn',{target:function(a){return a.nextElementSibling}}).on('success',function(a){a.trigger.innerText="复制成功",setTimeout(function(){a.trigger.innerText="复制"},2e3)})})()</script></main></body></html>